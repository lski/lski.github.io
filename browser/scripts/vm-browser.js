var Browser=function(e,t,n,r,i,o,l){function d(r,i,o){function l(e){var n=t(e).map(function(e){return e.isFile&&e.isImage?e.icon=e.link:e.isFile?e.icon="content/images/blank-file-icon.png":e.icon="content/images/folder-icon.png",e});return x=n,c(),n}function d(n){var r=t.template(j),i=t(n).reduce(function(e,t){return e.append(r(t))},e("<div/>"));return F.empty().append(i),f(),n}function c(){n.trigger(F,"folder-contents-loaded")}function f(){n.trigger(F,"folder-contents-ui-updated")}function u(e){n.trigger(F,"folder-contents-folder-selected",{folder:e})}function a(e){n.trigger(F,"folder-contents-folder-opened",{folder:e})}function s(e){n.trigger(F,"folder-contents-file-selected",{file:e})}function p(e){n.trigger(F,"folder-contents-file-selected-complete",{file:e})}function g(e){return t(x).find(function(t){return t.id===e})}function h(){e(this).siblings().removeClass("selected").end().addClass("selected")}function m(){var e=k(this);I.set(e)&&s(e)}function v(){var e=k(this);p(e)}function w(){var e=k(this);I.set(e)&&u(e)}function b(){var e=k(this);a(e)}function k(e){var t=e.getAttribute("data-id");return g(t)}function y(){var e=null;this.get=function(){return e},this.set=function(t){return t==e?!1:(e=t||null,!0)}}var S=o,F=r,j=i;n.on(F,"click",".item",h),n.on(F,"click",".item-file",m),n.on(F,"click",".item-folder",w),n.on(F,"dblclick",".item-file",v),n.on(F,"dblclick",".item-folder",b),n.on(F,"dragenter",function(){e(this).css({"background-color":"#efefef"})}),n.on(F,"dragleave dragend drop",function(){e(this).css({"background-color":"transparent"})});var x=[],I=new y;this.load=function(e){return S.getFolderContent(e).then(l).then(d)}}function c(e,r){function i(e){return o(g,e)}function o(e,t){if(e.id===t)return e;for(var n=0,r=e.directories.length;r>n;n++){var i=o(e.directories[n],t);if(i)return i}return null}function l(e){n.trigger(p,"folder-tree-folder-changed",{folder:e})}function d(e){g=e||null,c(e)}function c(e){var t=p.jstree({core:{data:f(e)}});t.on("ready.jstree",function(){a.selectById("Lw")})}function f(e){return{id:"folder-item-"+e.id,text:e.name,a_attr:{"data-path":e.path,"data-id":e.id,"class":"tree-item-folder"},state:{opened:!0},children:t(e.directories).map(f)}}function u(){var e=null;this.get=function(){return e},this.getPath=function(){return e?e.path:null},this.set=function(t){return t==e?!1:(e=t||null,!0)},this.clear=function(){e=null},this.has=function(){return null===e}}var a=this,s=r,p=e,g=null,h=new u;p.on("select_node.jstree",function(e,t){var n=t.node.a_attr["data-id"],r=i(n);h.set(r),l(r),e.stopPropagation()}),s.getFolderTree().done(d),this.selectById=function(e){p.jstree("deselect_all"),p.jstree("select_node",p.find('[data-id="'+e+'"]').parent())},this.getSelectedFolderPath=function(){return h.getPath()}}function f(t,i){function o(){u&&r.confirm("Are you sure you want to delete this file? \n\nIt could be being used",function(e){e&&c.deleteItem(u.id).done(l)})}function l(){f.updateSelected(null),n.trigger(d,"details-bar-item-deleted")}var d=t,c=i,f=this,u=null,a=e(".file-selected",t);n.on(d,"click",".delete",o),this.updateSelected=function(e){e?(u=e,a.text(e.name),a.attr({href:e.link})):(u=null,a.text(""))}}function u(t,n){function r(e){return i+e}var i=t,o="string"==typeof n?function(){return n}:"function"==typeof n?n:null;o&&e.ajaxSetup({beforeSend:function(e){e.setRequestHeader("Authorization","Bearer "+n())}}),this.deleteItem=function(t){return e.ajax({url:r("/api/browser/file/"+t),type:"DELETE",dataType:"json"})},this.getFolderContent=function(t){return e.getJSON(r("/api/browser/folder/contents"),{path:t})},this.getFolderTree=function(){return e.getJSON(r("/api/browser/folder"))},this.resolveApi=r}return function(t){function o(e){n.fire(a(),"file-selected",{file:e})}function l(){n.fire(a(),"file-deselected")}function a(){return i.frameElement||i.top||[]}function s(){k.updateSelected(null),h.removeClass("file-selected")}function p(e){k.updateSelected(e),h.addClass("file-selected")}var g=t||{apiUrl:"",token:null},h=e("#file-browser"),m=e('[type="file"]',h),v=new u(g.apiUrl,g.token),w=new d(e(".browser-contents",h),e("#template").text(),v),b=new c(e(".browser-folders",h),v),k=new f(e(".details",h),v);n.on(h,"folder-tree-folder-changed",function(e){w.load(e.detail.folder.path),s()}),n.on(h,"folder-contents-folder-opened",function(e){b.selectById(e.detail.folder.id),s()}),n.on(h,"folder-contents-file-selected",function(e){p(e.detail.file),o(e.detail.file)}),n.on(h,"folder-contents-folder-selected",function(){s(),l()}),n.on(h,"details-bar-item-deleted",function(){w.load(b.getSelectedFolderPath())}),m.fileupload({url:v.resolveApi("/api/browser/upload")}).on("fileuploadadd",function(e,t){var n=b.getSelectedFolderPath();n&&(t.formData={path:n},t.submit())}).on("fileuploaddone",function(){w.load(b.getSelectedFolderPath())}).on("fileuploadfail",function(e,t){try{r.alert(JSON.parse(t.xhr().responseText).message)}catch(n){r.alert("There was an error uploading the file")}})}}(jQuery,_,window.lski.events,window.lski.alerts,window,document);
//# sourceMappingURL=../../maps/browser/scripts/vm-browser.js.map
