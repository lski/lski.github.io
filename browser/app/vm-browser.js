"use strict";var Browser=function(e,t,n,i){function r(r){function l(e){t.fire(f(),"file-selected",{file:e})}function s(){t.fire(f(),"file-deselected")}function f(){return i.frameElement||i.top||[]}function u(){k.updateSelected(null),g.removeClass("file-selected")}function h(e){k.updateSelected(e),g.addClass("file-selected")}var p=r||{apiUrl:"",token:null},g=e("#file-browser"),m=e('[type="file"]',g),v=new c(p.apiUrl,p.token),w=new o(e(".browser-contents",g),v),b=new d(e(".browser-folders",g),v),k=new a(e(".details",g),v);t.on(g,"folder-tree-folder-changed",function(e){w.load(e.detail.folder.path),u()}),t.on(g,"folder-contents-folder-opened",function(e){b.selectById(e.detail.folder.id),u()}),t.on(g,"folder-contents-file-selected",function(e){h(e.detail.file),l(e.detail.file)}),t.on(g,"folder-contents-folder-selected",function(){u(),s()}),t.on(g,"details-bar-item-deleted",function(){w.load(b.getSelectedFolderPath())}),m.fileupload({url:v.resolveApi("/api/browser/upload")}).on("fileuploadadd",function(e,t){var n=b.getSelectedFolderPath();n&&(t.formData={path:n},t.submit())}).on("fileuploaddone",function(){w.load(b.getSelectedFolderPath())}).on("fileuploadfail",function(e,t){try{n.alert(JSON.parse(t.xhr().responseText).message)}catch(i){n.alert("There was an error uploading the file")}})}function o(n,i){function r(e){var t=e.map(function(e){return e.isFile&&e.isImage?e.icon=e.link:e.isFile?e.icon="content/images/blank-file-icon.png":e.icon="content/images/folder-icon.png",e});return S=t,d(),t}function o(t){var n=t.reduce(function(e,t){return e.append(new l(t).render())},e("<div/>"));return F.empty().append(n),a(),t}function d(){t.trigger(F,"folder-contents-loaded")}function a(){t.trigger(F,"folder-contents-ui-updated")}function c(e){t.trigger(F,"folder-contents-folder-selected",{folder:e})}function s(e){t.trigger(F,"folder-contents-folder-opened",{folder:e})}function f(e){t.trigger(F,"folder-contents-file-selected",{file:e})}function u(e){t.trigger(F,"folder-contents-file-selected-complete",{file:e})}function h(e){return S.find(function(t){return t.id===e})}function p(){e(this).siblings().removeClass("selected").end().addClass("selected")}function g(){var e=b(this);I.set(e)&&f(e)}function m(){var e=b(this);u(e)}function v(){var e=b(this);I.set(e)&&c(e)}function w(){var e=b(this);s(e)}function b(e){var t=e.getAttribute("data-id");return h(t)}function k(){var e=null;this.get=function(){return e},this.set=function(t){return t==e?!1:(e=t||null,!0)}}var y=i,F=n;t.on(F,"click",".item",p),t.on(F,"click",".item-file",g),t.on(F,"click",".item-folder",v),t.on(F,"dblclick",".item-file",m),t.on(F,"dblclick",".item-folder",w),t.on(F,"dragenter",function(){e(this).css({"background-color":"#efefef"})}),t.on(F,"dragleave dragend drop",function(){e(this).css({"background-color":"transparent"})});var S=[],I=new k;this.load=function(e){return y.getFolderContent(e).then(r).then(o)}}function l(e){this.id=e.id,this.isFile=e.isFile,this.isImage=e.isImage,this.path=e.path,this.link=e.link,this.icon=e.icon,this.name=e.name}function d(e,n){function i(e){return r(h,e)}function r(e,t){if(e.id===t)return e;for(var n=0,i=e.directories.length;i>n;n++){var o=r(e.directories[n],t);if(o)return o}return null}function o(e){t.trigger(u,"folder-tree-folder-changed",{folder:e})}function l(e){h=e||null,d(e)}function d(e){var t=u.jstree({core:{data:a(e)}});t.on("ready.jstree",function(){s.selectById("Lw")})}function a(e){return{id:"folder-item-"+e.id,text:e.name,a_attr:{"data-path":e.path,"data-id":e.id,"class":"tree-item-folder"},state:{opened:!0},children:(e.directories||[]).map(a)}}function c(){var e=null;this.get=function(){return e},this.getPath=function(){return e?e.path:null},this.set=function(t){return t==e?!1:(e=t||null,!0)},this.clear=function(){e=null},this.has=function(){return null===e}}var s=this,f=n,u=e,h=null,p=new c;u.on("select_node.jstree",function(e,t){var n=t.node.a_attr["data-id"],r=i(n);p.set(r),o(r),e.stopPropagation()}),f.getFolderTree().done(l),this.selectById=function(e){u.jstree("deselect_all"),u.jstree("select_node",u.find('[data-id="'+e+'"]').parent())},this.getSelectedFolderPath=function(){return p.getPath()}}function a(i,r){function o(){s&&n.confirm("Are you sure you want to delete this file? \n\nIt could be being used",function(e){e&&a.deleteItem(s.id).done(l)})}function l(){c.updateSelected(null),t.trigger(d,"details-bar-item-deleted")}var d=i,a=r,c=this,s=null,f=e(".file-selected",i);t.on(d,"click",".delete",o),this.updateSelected=function(e){e?(s=e,f.text(e.name),f.attr({href:e.link})):(s=null,f.text(""))}}function c(t,n){function i(e){return r+e}var r=t,o="string"==typeof n?function(){return n}:"function"==typeof n?n:null;o&&e.ajaxSetup({beforeSend:function(e){e.setRequestHeader("Authorization","Bearer "+n())}}),this.deleteItem=function(t){return e.ajax({url:i("/api/browser/file/"+t),type:"DELETE",dataType:"json"})},this.getFolderContent=function(t){return e.getJSON(i("/api/browser/folder/contents"),{path:t})},this.getFolderTree=function(){return e.getJSON(i("/api/browser/folder"))},this.resolveApi=i}return l.prototype.render=function(){var e=this.isFile?"item-file"+(this.isImage?" item-image":""):"item-folder",t=this.isFile?this.link:this.path,n='<div class="item '+e+'" title="'+t+'" data-id="'+this.id+'"><div class="item-icon"><span></span><img src="'+this.icon+'" /></div><div class="item-caption"><span>'+this.name+"</span></div></div>";return n},r}(jQuery,window.lski.events,window.lski.alerts,window);
//# sourceMappingURL=../maps/app/vm-browser.js.map
