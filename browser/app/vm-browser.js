"use strict";var Browser=function(e,t,n,i,r){function o(o,d){function f(){m.prepend('<div class="file-browser"><input type="file" name="posted" style="display:none;" /><div class="browser"><div class="browser-folders"></div><div class="browser-contents"></div></div><footer class="details"><div><img class="delete" src="content/images/close.png" /><a class="file-selected" target="_blank"></a></div></footer></div>')}function u(e){t.fire(h(),"file-selected",{file:e})}function p(){t.fire(h(),"file-deselected")}function h(){var e=[m[0]];return i.frameElement?e.push(i.frameElement):i.parent!==i&&e.push(i.parent),e}function g(){S.updateSelected(null),m.find("> div.file-browser").removeClass("file-selected")}function v(e){S.updateSelected(e),m.find("> div.file-browser").addClass("file-selected")}var m=e(o||r.body),w=d||{apiUrl:"",token:null};f();var b=e('[type="file"]',m),k=new c(w.apiUrl,w.token),y=new l(e(".browser-contents",m),k),F=new s(e(".browser-folders",m),k),S=new a(e(".details",m),k);t.on(m,"folder-tree-folder-changed",function(e){y.load(e.detail.folder.path),g()}),t.on(m,"folder-contents-folder-opened",function(e){F.selectById(e.detail.folder.id),g()}),t.on(m,"folder-contents-file-selected",function(e){v(e.detail.file),u(e.detail.file)}),t.on(m,"folder-contents-folder-selected",function(){g(),p()}),t.on(m,"details-bar-item-deleted",function(){y.load(F.getSelectedFolderPath())}),b.fileupload({url:k.resolveApi("/api/browser/upload")}).on("fileuploadadd",function(e,t){var n=F.getSelectedFolderPath();n&&(t.formData={path:n},t.submit())}).on("fileuploaddone",function(){y.load(F.getSelectedFolderPath())}).on("fileuploadfail",function(e,t){try{n.alert(JSON.parse(t.xhr().responseText).message)}catch(i){n.alert("There was an error uploading the file")}})}function l(n,i){function r(e){var t=e.map(function(e){return e.isFile&&e.isImage?e.icon=e.link:e.isFile?e.icon="content/images/blank-file-icon.png":e.icon="content/images/folder-icon.png",e});return S=t,l(),t}function o(t){var n=t.reduce(function(e,t){return e.append(new d(t).render())},e("<div/>"));return F.empty().append(n),s(),t}function l(){t.trigger(F,"folder-contents-loaded")}function s(){t.trigger(F,"folder-contents-ui-updated")}function a(e){t.trigger(F,"folder-contents-folder-selected",{folder:e})}function c(e){t.trigger(F,"folder-contents-folder-opened",{folder:e})}function f(e){t.trigger(F,"folder-contents-file-selected",{file:e})}function u(e){t.trigger(F,"folder-contents-file-selected-complete",{file:e})}function p(e){return S.find(function(t){return t.id===e})}function h(){e(this).siblings().removeClass("selected").end().addClass("selected")}function g(){var e=b(this);I.set(e)&&f(e)}function v(){var e=b(this);u(e)}function m(){var e=b(this);I.set(e)&&a(e)}function w(){var e=b(this);c(e)}function b(e){var t=e.getAttribute("data-id");return p(t)}function k(){var e=null;this.get=function(){return e},this.set=function(t){return t==e?!1:(e=t||null,!0)}}var y=i,F=n;t.on(F,"click",".item",h),t.on(F,"click",".item-file",g),t.on(F,"click",".item-folder",m),t.on(F,"dblclick",".item-file",v),t.on(F,"dblclick",".item-folder",w),t.on(F,"dragenter",function(){e(this).css({"background-color":"#efefef"})}),t.on(F,"dragleave dragend drop",function(){e(this).css({"background-color":"transparent"})});var S=[],I=new k;this.load=function(e){return y.getFolderContent(e).then(r).then(o)}}function d(e){this.id=e.id,this.isFile=e.isFile,this.isImage=e.isImage,this.path=e.path,this.link=e.link,this.icon=e.icon,this.name=e.name}function s(e,n){function i(e){return r(p,e)}function r(e,t){if(e.id===t)return e;for(var n=0,i=e.directories.length;i>n;n++){var o=r(e.directories[n],t);if(o)return o}return null}function o(e){t.trigger(u,"folder-tree-folder-changed",{folder:e})}function l(e){p=e||null,d(e)}function d(e){var t=u.jstree({core:{data:s(e)}});t.on("ready.jstree",function(){c.selectById("Lw")})}function s(e){return{id:"folder-item-"+e.id,text:e.name,a_attr:{"data-path":e.path,"data-id":e.id,"class":"tree-item-folder"},state:{opened:!0},children:(e.directories||[]).map(s)}}function a(){var e=null;this.get=function(){return e},this.getPath=function(){return e?e.path:null},this.set=function(t){return t==e?!1:(e=t||null,!0)},this.clear=function(){e=null},this.has=function(){return null===e}}var c=this,f=n,u=e,p=null,h=new a;u.on("select_node.jstree",function(e,t){var n=t.node.a_attr["data-id"],r=i(n);h.set(r),o(r),e.stopPropagation()}),f.getFolderTree().done(l),this.selectById=function(e){u.jstree("deselect_all"),u.jstree("select_node",u.find('[data-id="'+e+'"]').parent())},this.getSelectedFolderPath=function(){return h.getPath()}}function a(i,r){function o(){c&&n.confirm("Are you sure you want to delete this file? \n\nIt could be being used",function(e){e&&s.deleteItem(c.id).done(l)})}function l(){a.updateSelected(null),t.trigger(d,"details-bar-item-deleted")}var d=i,s=r,a=this,c=null,f=e(".file-selected",i);t.on(d,"click",".delete",o),this.updateSelected=function(e){e?(c=e,f.text(e.name),f.attr({href:e.link})):(c=null,f.text(""))}}function c(t,n){function i(e){return r+e}var r=t,o="string"==typeof n?function(){return n}:"function"==typeof n?n:null;o&&e.ajaxSetup({beforeSend:function(e){e.setRequestHeader("Authorization","Bearer "+n())}}),this.deleteItem=function(t){return e.ajax({url:i("/api/browser/file/"+t),type:"DELETE",dataType:"json"})},this.getFolderContent=function(t){return e.getJSON(i("/api/browser/folder/contents"),{path:t})},this.getFolderTree=function(){return e.getJSON(i("/api/browser/folder"))},this.resolveApi=i}return d.prototype.render=function(){var e=this.isFile?"item-file"+(this.isImage?" item-image":""):"item-folder",t=this.isFile?this.link:this.path,n='<div class="item '+e+'" title="'+t+'" data-id="'+this.id+'"><div class="item-icon"><span></span><img src="'+this.icon+'" /></div><div class="item-caption"><span>'+this.name+"</span></div></div>";return n},o}(jQuery,window.lski.events,window.lski.alerts,window,document);
//# sourceMappingURL=../maps/app/vm-browser.js.map
