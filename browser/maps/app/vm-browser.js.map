{"version":3,"sources":["app/vm-browser.js"],"names":["Browser","$","events","message","window","settings","fireFileSelected","file","fire","getParentToFireAgainst","fireFileDeselected","frameElement","top","clearSelected","_detailsBar","updateSelected","_browser","removeClass","addClass","_settings","apiUrl","token","_browserFileInput","_ctx","DataContext","_folderContents","DirectoryContents","_folderTree","FolderTree","DetailsBar","on","e","load","detail","folder","path","selectById","id","getSelectedFolderPath","fileupload","url","resolveApi","data","formData","submit","evt","err","alert","JSON","parse","xhr","responseText","vm","ctx","onFolderContentsLoaded","response","items","map","item","isFile","isImage","icon","link","_contents","fireIsLoaded","updateContentsUI","container","reduce","append","LargeContentItem","render","_vm","empty","fireIsUpdated","trigger","fireFolderSelected","fireFolderOpened","fireFileSelectedComplete","getItemWithId","find","onItemSelected","this","siblings","end","onFileClicked","getContentItemFromElement","_selected","set","onFileDoubleClicked","onFolderClicked","onFolderDoubleClicked","element","getAttribute","Selected","_file","get","css","background-color","folderPath","getFolderContent","then","name","getFolderWithId","findFolderRecursive","_folders","dir","i","n","directories","length","result","fireDirectoryChanged","onFolderTreeLoaded","createTree","tree","jstree","core","toTreeNode","_this","text","a_attr","data-path","data-id","class","state","opened","children","_folder","getPath","clear","has","node","stopPropagation","getFolderTree","done","parent","onDeleteClick","confirm","answer","deleteItem","fireOnDelete","_fileSelected","attr","href","_root","_token","ajaxSetup","beforeSend","setRequestHeader","ajax","type","dataType","getJSON","prototype","classes","title","s","jQuery","lski","alerts"],"mappings":"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","file":"app/vm-browser.js","sourcesContent":["'use strict';\n\nvar Browser = function ($, events, message, window) {\n\n\tfunction Browser(settings) {\n\n\t\tvar _settings = settings || {\n\t\t\tapiUrl: '',\n\t\t\ttoken: null\n\t\t},\n\t\t    _browser = $('#file-browser'),\n\t\t    _browserFileInput = $('[type=\"file\"]', _browser),\n\t\t    _ctx = new DataContext(_settings.apiUrl, _settings.token),\n\t\t    _folderContents = new DirectoryContents($('.browser-contents', _browser), _ctx),\n\t\t    _folderTree = new FolderTree($('.browser-folders', _browser), _ctx),\n\t\t    _detailsBar = new DetailsBar($('.details', _browser), _ctx);\n\n\t\t/**\r\n   * Application events for the users of the app can subscribe too\r\n   */\n\n\t\tfunction fireFileSelected(file) {\n\t\t\tevents.fire(getParentToFireAgainst(), 'file-selected', { file: file });\n\t\t}\n\n\t\tfunction fireFileDeselected() {\n\t\t\tevents.fire(getParentToFireAgainst(), 'file-deselected');\n\t\t}\n\n\t\tfunction fireFileSelectedComplete(file) {\n\t\t\tevents.fire(getParentToFireAgainst(), 'file-selected-complete', { file: file });\n\t\t}\n\n\t\tfunction getParentToFireAgainst() {\n\t\t\treturn window.frameElement || window.top || [];\n\t\t}\n\n\t\t/**\r\n   * Handle Component Events\r\n   */\n\n\t\tevents.on(_browser, 'folder-tree-folder-changed', function (e) {\n\n\t\t\t_folderContents.load(e.detail.folder.path);\n\t\t\tclearSelected();\n\t\t});\n\n\t\tevents.on(_browser, 'folder-contents-folder-opened', function (e) {\n\n\t\t\t_folderTree.selectById(e.detail.folder.id);\n\t\t\tclearSelected();\n\t\t});\n\n\t\tevents.on(_browser, 'folder-contents-file-selected', function (e) {\n\n\t\t\tupdateSelected(e.detail.file);\n\t\t\tfireFileSelected(e.detail.file);\n\t\t});\n\n\t\tevents.on(_browser, 'folder-contents-folder-selected', function () {\n\n\t\t\tclearSelected();\n\t\t\tfireFileDeselected();\n\t\t});\n\n\t\tfunction clearSelected() {\n\n\t\t\t_detailsBar.updateSelected(null);\n\t\t\t_browser.removeClass('file-selected');\n\t\t}\n\n\t\tfunction updateSelected(file) {\n\n\t\t\t_detailsBar.updateSelected(file);\n\t\t\t_browser.addClass('file-selected');\n\t\t}\n\n\t\tevents.on(_browser, 'details-bar-item-deleted', function () {\n\t\t\t// Refresh the current content items\n\t\t\t_folderContents.load(_folderTree.getSelectedFolderPath());\n\t\t});\n\n\t\t// Use jquery on as internally it uses triggerHandler rather than trigger\n\t\t_browserFileInput.fileupload({ url: _ctx.resolveApi('/api/browser/upload') }).on('fileuploadadd', function onFileUploadAdd(e, data) {\n\n\t\t\tvar path = _folderTree.getSelectedFolderPath();\n\n\t\t\t// If there is not currently a selected folder then stop\n\t\t\tif (!path) {\n\t\t\t\treturn;\n\t\t\t}\n\n\t\t\t// Prior to sending the file, we need to add the folder path so it knows where to store it\n\t\t\tdata.formData = { path: path };\n\t\t\tdata.submit();\n\t\t}).on('fileuploaddone', function onFileUploadDone() {\n\t\t\t// Refresh the current content items\n\t\t\t_folderContents.load(_folderTree.getSelectedFolderPath());\n\t\t}).on('fileuploadfail', function onFileUploadFailed(evt, err) {\n\n\t\t\ttry {\n\t\t\t\tmessage.alert(JSON.parse(err.xhr().responseText).message);\n\t\t\t} catch (e) {\n\t\t\t\tmessage.alert('There was an error uploading the file');\n\t\t\t}\n\t\t});\n\t}\n\n\t/**\r\n  * Components\r\n  */\n\n\tfunction DirectoryContents(vm, ctx) {\n\n\t\tvar _ctx = ctx,\n\t\t    _vm = vm;\n\n\t\tevents.on(_vm, 'click', '.item', onItemSelected);\n\t\tevents.on(_vm, 'click', '.item-file', onFileClicked);\n\t\tevents.on(_vm, 'click', '.item-folder', onFolderClicked);\n\t\tevents.on(_vm, 'dblclick', '.item-file', onFileDoubleClicked);\n\t\tevents.on(_vm, 'dblclick', '.item-folder', onFolderDoubleClicked); // Changes the folder selected\n\t\tevents.on(_vm, 'dragenter', function () {\n\t\t\t$(this).css({ 'background-color': '#efefef' });\n\t\t});\n\t\tevents.on(_vm, 'dragleave dragend drop', function () {\n\t\t\t$(this).css({ 'background-color': 'transparent' });\n\t\t});\n\n\t\tvar _contents = [],\n\t\t    _selected = new Selected(); // TODO: replace the logic here to accept items too\n\n\t\tthis.load = function (folderPath) {\n\n\t\t\treturn _ctx.getFolderContent(folderPath).then(onFolderContentsLoaded).then(updateContentsUI);\n\t\t};\n\n\t\tfunction onFolderContentsLoaded(response) {\n\n\t\t\tvar items = response.map(function (item) {\n\n\t\t\t\tif (item.isFile && item.isImage) {\n\t\t\t\t\titem.icon = item.link;\n\t\t\t\t} else if (item.isFile) {\n\t\t\t\t\titem.icon = 'content/images/blank-file-icon.png';\n\t\t\t\t} else {\n\t\t\t\t\titem.icon = 'content/images/folder-icon.png';\n\t\t\t\t}\n\n\t\t\t\treturn item;\n\t\t\t});\n\n\t\t\t_contents = items;\n\t\t\tfireIsLoaded();\n\n\t\t\treturn items;\n\t\t}\n\n\t\tfunction updateContentsUI(items) {\n\n\t\t\tvar container = items.reduce(function (container, item) {\n\n\t\t\t\treturn container.append(new LargeContentItem(item).render());\n\t\t\t}, $('<div/>'));\n\n\t\t\t_vm.empty().append(container);\n\n\t\t\tfireIsUpdated();\n\n\t\t\treturn items;\n\t\t}\n\n\t\tfunction fireIsLoaded() {\n\t\t\tevents.trigger(_vm, 'folder-contents-loaded');\n\t\t}\n\n\t\tfunction fireIsUpdated() {\n\t\t\tevents.trigger(_vm, 'folder-contents-ui-updated');\n\t\t}\n\n\t\tfunction fireFolderSelected(folder) {\n\t\t\tevents.trigger(_vm, 'folder-contents-folder-selected', { folder: folder });\n\t\t}\n\n\t\tfunction fireFolderOpened(folder) {\n\t\t\tevents.trigger(_vm, 'folder-contents-folder-opened', { folder: folder });\n\t\t}\n\n\t\tfunction fireFileSelected(file) {\n\t\t\tevents.trigger(_vm, 'folder-contents-file-selected', { file: file });\n\t\t}\n\n\t\tfunction fireFileSelectedComplete(file) {\n\t\t\tevents.trigger(_vm, 'folder-contents-file-selected-complete', { file: file });\n\t\t}\n\n\t\tfunction getItemWithId(id) {\n\n\t\t\treturn _contents.find(function (item) {\n\t\t\t\treturn item.id === id;\n\t\t\t});\n\t\t}\n\n\t\tfunction onItemSelected() {\n\n\t\t\t$(this).siblings().removeClass('selected').end().addClass('selected');\n\t\t}\n\n\t\tfunction onFileClicked() {\n\n\t\t\tvar item = getContentItemFromElement(this);\n\n\t\t\tif (_selected.set(item)) {\n\t\t\t\tfireFileSelected(item);\n\t\t\t}\n\t\t}\n\n\t\tfunction onFileDoubleClicked() {\n\n\t\t\tvar item = getContentItemFromElement(this);\n\n\t\t\tfireFileSelectedComplete(item);\n\t\t}\n\n\t\tfunction onFolderClicked() {\n\n\t\t\tvar item = getContentItemFromElement(this);\n\n\t\t\tif (_selected.set(item)) {\n\t\t\t\tfireFolderSelected(item);\n\t\t\t}\n\t\t}\n\n\t\tfunction onFolderDoubleClicked() {\n\n\t\t\tvar item = getContentItemFromElement(this);\n\n\t\t\tfireFolderOpened(item);\n\t\t}\n\n\t\tfunction getContentItemFromElement(element) {\n\n\t\t\tvar id = element.getAttribute('data-id');\n\t\t\treturn getItemWithId(id);\n\t\t}\n\n\t\tfunction Selected() {\n\n\t\t\tvar _file = null;\n\n\t\t\tthis.get = function () {\n\t\t\t\treturn _file;\n\t\t\t};\n\n\t\t\tthis.set = function (file) {\n\n\t\t\t\tif (file == _file) {\n\t\t\t\t\treturn false;\n\t\t\t\t}\n\n\t\t\t\t_file = file || null;\n\t\t\t\treturn true;\n\t\t\t};\n\t\t}\n\t}\n\n\tfunction LargeContentItem(item) {\n\n\t\tthis.id = item.id;\n\t\tthis.isFile = item.isFile;\n\t\tthis.isImage = item.isImage;\n\t\tthis.path = item.path;\n\t\tthis.link = item.link;\n\t\tthis.icon = item.icon;\n\t\tthis.name = item.name;\n\t}\n\n\tLargeContentItem.prototype.render = function () {\n\n\t\tvar classes = !this.isFile ? 'item-folder' : 'item-file' + (this.isImage ? ' item-image' : ''),\n\t\t    title = !this.isFile ? this.path : this.link;\n\n\t\tvar s = '<div class=\"item ' + classes + '\" title=\"' + title + '\" data-id=\"' + this.id + '\">' + '<div class=\"item-icon\">' + '<span></span><img src=\"' + this.icon + '\" />' + '</div>' + '<div class=\"item-caption\">' + '<span>' + this.name + '</span>' + '</div>' + '</div>';\n\n\t\treturn s;\n\t};\n\n\tfunction FolderTree(vm, ctx) {\n\n\t\tvar _this = this,\n\t\t    _ctx = ctx,\n\t\t    _vm = vm,\n\t\t    _folders = null,\n\t\t    _selected = new Selected();\n\n\t\t// Due to the fact it fires only through jquery, and not natively we use this method with jstree\n\t\t_vm.on('select_node.jstree', function (e, data) {\n\n\t\t\tvar id = data.node.a_attr['data-id'];\n\t\t\tvar folder = getFolderWithId(id);\n\n\t\t\t_selected.set(folder);\n\n\t\t\tfireDirectoryChanged(folder);\n\n\t\t\te.stopPropagation();\n\t\t});\n\n\t\t_ctx.getFolderTree().done(onFolderTreeLoaded);\n\n\t\tthis.selectById = function (id) {\n\t\t\t// Selects node, which fires is caught and then is rethrown with relevant data for subscribers\n\t\t\t_vm.jstree('deselect_all');\n\t\t\t_vm.jstree('select_node', _vm.find('[data-id=\"' + id + '\"]').parent());\n\t\t};\n\n\t\tthis.getSelectedFolderPath = function () {\n\n\t\t\treturn _selected.getPath();\n\t\t};\n\n\t\tfunction getFolderWithId(id) {\n\t\t\treturn findFolderRecursive(_folders, id);\n\t\t}\n\n\t\t/**\r\n   * Searches through the loaded folders\r\n   */\n\t\tfunction findFolderRecursive(dir, id) {\n\n\t\t\tif (dir.id === id) {\n\t\t\t\treturn dir;\n\t\t\t}\n\n\t\t\tfor (var i = 0, n = dir.directories.length; i < n; i++) {\n\t\t\t\tvar result = findFolderRecursive(dir.directories[i], id);\n\t\t\t\tif (result) {\n\t\t\t\t\treturn result;\n\t\t\t\t}\n\t\t\t}\n\n\t\t\treturn null;\n\t\t}\n\n\t\tfunction fireDirectoryChanged(folder) {\n\t\t\tevents.trigger(_vm, 'folder-tree-folder-changed', { folder: folder });\n\t\t}\n\n\t\tfunction onFolderTreeLoaded(data) {\n\n\t\t\t_folders = data || null;\n\t\t\tcreateTree(data);\n\t\t}\n\n\t\tfunction createTree(data) {\n\n\t\t\tvar tree = _vm.jstree({\n\t\t\t\tcore: {\n\t\t\t\t\tdata: toTreeNode(data)\n\t\t\t\t}\n\t\t\t});\n\n\t\t\ttree.on(\"ready.jstree\", function () {\n\t\t\t\t_this.selectById(\"Lw\");\n\t\t\t});\n\t\t}\n\n\t\t/**\r\n  * Takes the DirectoryItem data and converts it into a format used by jsTree, creates the tree re-cursively\r\n  */\n\t\tfunction toTreeNode(data) {\n\n\t\t\treturn {\n\t\t\t\tid: 'folder-item-' + data.id,\n\t\t\t\ttext: data.name,\n\t\t\t\ta_attr: {\n\t\t\t\t\t'data-path': data.path,\n\t\t\t\t\t'data-id': data.id,\n\t\t\t\t\t'class': 'tree-item-folder'\n\t\t\t\t},\n\t\t\t\tstate: {\n\t\t\t\t\topened: true\n\t\t\t\t},\n\t\t\t\tchildren: (data.directories || []).map(toTreeNode)\n\t\t\t};\n\t\t}\n\n\t\tfunction Selected() {\n\n\t\t\tvar _folder = null;\n\n\t\t\tthis.get = function () {\n\t\t\t\treturn _folder;\n\t\t\t};\n\n\t\t\tthis.getPath = function () {\n\t\t\t\treturn _folder ? _folder.path : null;\n\t\t\t};\n\n\t\t\tthis.set = function (folder) {\n\n\t\t\t\tif (folder == _folder) {\n\t\t\t\t\treturn false;\n\t\t\t\t}\n\n\t\t\t\t_folder = folder || null;\n\t\t\t\treturn true;\n\t\t\t};\n\n\t\t\tthis.clear = function () {\n\t\t\t\t_folder = null;\n\t\t\t};\n\n\t\t\tthis.has = function () {\n\t\t\t\treturn _folder === null;\n\t\t\t};\n\t\t}\n\t}\n\n\tfunction DetailsBar(vm, ctx) {\n\n\t\tvar _vm = vm,\n\t\t    _ctx = ctx,\n\t\t    _this = this,\n\t\t    _selected = null,\n\t\t    _fileSelected = $('.file-selected', vm);\n\n\t\tevents.on(_vm, 'click', '.delete', onDeleteClick);\n\n\t\tthis.updateSelected = function (file) {\n\n\t\t\tif (file) {\n\t\t\t\t_selected = file;\n\t\t\t\t_fileSelected.text(file.name);\n\t\t\t\t_fileSelected.attr({ href: file.link });\n\t\t\t} else {\n\t\t\t\t_selected = null;\n\t\t\t\t_fileSelected.text('');\n\t\t\t}\n\t\t};\n\n\t\tfunction onDeleteClick() {\n\n\t\t\tif (!_selected) {\n\t\t\t\treturn;\n\t\t\t}\n\n\t\t\tmessage.confirm('Are you sure you want to delete this file? \\n\\nIt could be being used', function (answer) {\n\n\t\t\t\tif (!answer) {\n\t\t\t\t\treturn;\n\t\t\t\t}\n\n\t\t\t\t_ctx.deleteItem(_selected.id).done(fireOnDelete);\n\t\t\t});\n\t\t}\n\n\t\tfunction fireOnDelete() {\n\t\t\t_this.updateSelected(null);\n\t\t\tevents.trigger(_vm, 'details-bar-item-deleted');\n\t\t}\n\t}\n\n\tfunction DataContext(apiUrl, token) {\n\n\t\tvar _root = apiUrl,\n\t\t    _token = typeof token === \"string\" ? function () {\n\t\t\treturn token;\n\t\t} : typeof token === \"function\" ? token : null;\n\n\t\tif (_token) {\n\t\t\t$.ajaxSetup({\n\t\t\t\tbeforeSend: function beforeSend(xhr) {\n\t\t\t\t\txhr.setRequestHeader(\"Authorization\", \"Bearer \" + token());\n\t\t\t\t}\n\t\t\t});\n\t\t}\n\n\t\tfunction resolveApi(path) {\n\t\t\treturn _root + path;\n\t\t}\n\n\t\tthis.deleteItem = function (id) {\n\n\t\t\treturn $.ajax({\n\t\t\t\turl: resolveApi('/api/browser/file/' + id),\n\t\t\t\ttype: 'DELETE',\n\t\t\t\tdataType: 'json'\n\t\t\t});\n\t\t};\n\n\t\tthis.getFolderContent = function (folderPath) {\n\n\t\t\treturn $.getJSON(resolveApi('/api/browser/folder/contents'), { path: folderPath });\n\t\t};\n\n\t\tthis.getFolderTree = function () {\n\t\t\treturn $.getJSON(resolveApi('/api/browser/folder'));\n\t\t};\n\n\t\tthis.resolveApi = resolveApi;\n\t}\n\n\treturn Browser;\n}(jQuery, window.lski.events, window.lski.alerts, window);"],"sourceRoot":"/source/"}