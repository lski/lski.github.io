{"version":3,"sources":["browser/scripts/vm-browser.js"],"names":["Browser","$","_","events","message","window","document","undefined","DirectoryContents","vm","template","ctx","onFolderContentsLoaded","response","items","map","item","isFile","isImage","icon","link","_contents","fireIsLoaded","updateContentsUI","createUiItem","_template","container","reduce","append","_vm","empty","fireIsUpdated","trigger","fireFolderSelected","folder","fireFolderOpened","fireFileSelected","file","fireFileSelectedComplete","getItemWithId","id","find","onItemSelected","this","siblings","removeClass","end","addClass","onFileClicked","getContentItemFromElement","_selected","set","onFileDoubleClicked","onFolderClicked","onFolderDoubleClicked","element","getAttribute","Selected","_file","get","_ctx","on","css","background-color","load","folderPath","getFolderContent","then","FolderTree","getFolderWithId","findFolderRecursive","_folders","dir","i","n","directories","length","result","fireDirectoryChanged","onFolderTreeLoaded","data","createTree","tree","jstree","core","toTreeNode","_this","selectById","text","name","a_attr","data-path","path","data-id","class","state","opened","children","_folder","getPath","clear","has","e","node","stopPropagation","getFolderTree","done","parent","getSelectedFolderPath","DetailsBar","onDeleteClick","confirm","answer","deleteItem","fireOnDelete","updateSelected","_fileSelected","attr","href","DataContext","apiUrl","token","resolveApi","_root","_token","ajaxSetup","beforeSend","xhr","setRequestHeader","ajax","url","type","dataType","getJSON","settings","fire","getParentToFireAgainst","fireFileDeselected","frameElement","top","clearSelected","_detailsBar","_browser","_settings","_browserFileInput","_folderContents","_folderTree","detail","fileupload","formData","submit","evt","err","alert","JSON","parse","responseText","jQuery","lski","alerts"],"mappings":"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","file":"browser/scripts/vm-browser.js","sourcesContent":["var Browser = (function($, _, events, message, window, document, undefined) {\r\n\r\n\treturn function Browser(settings) {\r\n\r\n\t\tvar _settings = settings || {\r\n\t\t\t\tapiUrl: '',\r\n\t\t\t\ttoken: null\r\n\t\t\t},\r\n\t\t\t_browser = $('#file-browser'),\r\n\t\t\t_browserFileInput = $('[type=\"file\"]', _browser),\r\n\t\t\t_ctx = new DataContext(_settings.apiUrl, _settings.token),\r\n\t\t\t_folderContents = new DirectoryContents($('.browser-contents', _browser), $('#template').text(), _ctx),\r\n\t\t\t_folderTree = new FolderTree($('.browser-folders', _browser), _ctx),\r\n\t\t\t_detailsBar = new DetailsBar($('.details', _browser), _ctx);\r\n\r\n\t\t/**\r\n\t\t * Application events for the users of the app can subscribe too\r\n\t\t */\r\n\r\n\t\tfunction fireFileSelected(file) {\r\n\t\t\tevents.fire(getParentToFireAgainst(), 'file-selected', { file: file });\r\n\t\t}\r\n\r\n\t\tfunction fireFileDeselected() {\r\n\t\t\tevents.fire(getParentToFireAgainst(), 'file-deselected');\r\n\t\t}\r\n\r\n\t\tfunction fireFileSelectedComplete(file) {\r\n\t\t\tevents.fire(getParentToFireAgainst(), 'file-selected-complete', { file: file });\r\n\t\t}\r\n\r\n\t\tfunction getParentToFireAgainst() {\r\n\t\t\treturn window.frameElement || window.top || [];\r\n\t\t}\r\n\r\n\t\t/**\r\n\t\t * Handle Component Events\r\n\t\t */\r\n\r\n\t\tevents.on(_browser, 'folder-tree-folder-changed', function(e) {\r\n\r\n\t\t\t_folderContents.load(e.detail.folder.path);\r\n\t\t\tclearSelected();\r\n\t\t});\r\n\r\n\t\tevents.on(_browser, 'folder-contents-folder-opened', function(e) {\r\n\t\t\t\r\n\t\t\t_folderTree.selectById(e.detail.folder.id);\r\n\t\t\tclearSelected();\r\n\t\t});\r\n\r\n\t\tevents.on(_browser, 'folder-contents-file-selected', function(e) {\r\n\r\n\t\t\tupdateSelected(e.detail.file);\r\n\t\t\tfireFileSelected(e.detail.file);\r\n\t\t});\r\n\r\n\t\tevents.on(_browser, 'folder-contents-folder-selected', function() {\r\n\r\n\t\t\tclearSelected();\r\n\t\t\tfireFileDeselected();\r\n\t\t});\r\n\r\n\t\tfunction clearSelected() {\r\n\t\t\t\r\n\t\t\t_detailsBar.updateSelected(null);\r\n\t\t\t_browser.removeClass('file-selected');\r\n\t\t}\r\n\r\n\t\tfunction updateSelected(file) {\r\n\r\n\t\t\t_detailsBar.updateSelected(file);\r\n\t\t\t_browser.addClass('file-selected');\r\n\t\t}\r\n\r\n\t\tevents.on(_browser, 'details-bar-item-deleted', function() {\r\n\t\t\t// Refresh the current content items\r\n\t\t\t_folderContents.load(_folderTree.getSelectedFolderPath());\r\n\t\t});\r\n\r\n\t\t// Use jquery on as internally it uses triggerHandler rather than trigger\r\n\t\t_browserFileInput.fileupload({ url: _ctx.resolveApi('/api/browser/upload') })\r\n\t\t\t.on('fileuploadadd', function onFileUploadAdd(e, data) {\r\n\r\n\t\t\t\tvar path = _folderTree.getSelectedFolderPath();\r\n\r\n\t\t\t\t// If there is not currently a selected folder then stop\r\n\t\t\t\tif (!path) {\r\n\t\t\t\t\treturn;\r\n\t\t\t\t}\r\n\r\n\t\t\t\t// Prior to sending the file, we need to add the folder path so it knows where to store it\r\n\t\t\t\tdata.formData = { path: path };\r\n\t\t\t\tdata.submit();\r\n\t\t\t})\r\n\t\t\t.on('fileuploaddone', function onFileUploadDone() {\r\n\t\t\t\t// Refresh the current content items\r\n\t\t\t\t_folderContents.load(_folderTree.getSelectedFolderPath());\r\n\t\t\t})\r\n\t\t\t.on('fileuploadfail', function onFileUploadFailed(evt, err) {\r\n\r\n\t\t\t\ttry {\r\n\t\t\t\t\tmessage.alert(JSON.parse(err.xhr().responseText).message);\r\n\t\t\t\t} catch (e) {\r\n\t\t\t\t\tmessage.alert('There was an error uploading the file');\r\n\t\t\t\t}\r\n\r\n\t\t\t});\r\n\t}\r\n\t/**\r\n\t * Components\r\n\t */\r\n\r\n\tfunction DirectoryContents(vm, template, ctx) {\r\n\r\n\t\tvar _ctx = ctx,\r\n\t\t\t_vm = vm,\r\n\t\t\t_template = template; // TODO: Change this\r\n\r\n\t\tevents.on(_vm, 'click', '.item', onItemSelected);\r\n\t\tevents.on(_vm, 'click', '.item-file', onFileClicked);\r\n\t\tevents.on(_vm, 'click', '.item-folder', onFolderClicked);\r\n\t\tevents.on(_vm, 'dblclick', '.item-file', onFileDoubleClicked);\r\n\t\tevents.on(_vm, 'dblclick', '.item-folder', onFolderDoubleClicked); // Changes the folder selected\r\n\t\tevents.on(_vm, 'dragenter', function() { $(this).css({ 'background-color': '#efefef' }); });\r\n\t\tevents.on(_vm, 'dragleave dragend drop', function() { $(this).css({ 'background-color': 'transparent' }); });\r\n\r\n\t\tvar _contents = [],\r\n\t\t\t_selected = new Selected(); // TODO: replace the logic here to accept items too\r\n\r\n\t\tthis.load = function(folderPath) {\r\n\r\n\t\t\treturn _ctx.getFolderContent(folderPath)\r\n\t\t\t\t.then(onFolderContentsLoaded)\r\n\t\t\t\t.then(updateContentsUI);\r\n\t\t}\r\n\r\n\t\tfunction onFolderContentsLoaded(response) {\r\n\r\n\t\t\tvar items = _(response).map(function(item) {\r\n\r\n\t\t\t\tif (item.isFile && item.isImage) {\r\n\t\t\t\t\titem.icon = item.link;\r\n\t\t\t\t}\r\n\t\t\t\telse if (item.isFile) {\r\n\t\t\t\t\titem.icon = ('content/images/blank-file-icon.png');\r\n\t\t\t\t}\r\n\t\t\t\telse {\r\n\t\t\t\t\titem.icon = ('content/images/folder-icon.png');\r\n\t\t\t\t}\r\n\r\n\t\t\t\treturn item;\r\n\t\t\t});\r\n\r\n\t\t\t_contents = items;\r\n\t\t\tfireIsLoaded();\r\n\r\n\t\t\treturn items;\r\n\t\t}\r\n\r\n\t\tfunction updateContentsUI(items) {\r\n\r\n\t\t\tvar createUiItem = _.template(_template);\r\n\r\n\t\t\tvar container = _(items).reduce(function(container, item) {\r\n\r\n\t\t\t\treturn container.append(createUiItem(item));\r\n\r\n\t\t\t}, $('<div/>'));\r\n\r\n\t\t\t_vm.empty().append(container);\r\n\r\n\t\t\tfireIsUpdated();\r\n\r\n\t\t\treturn items;\r\n\t\t}\r\n\r\n\t\tfunction fireIsLoaded() {\r\n\t\t\tevents.trigger(_vm, 'folder-contents-loaded');\r\n\t\t}\r\n\r\n\t\tfunction fireIsUpdated() {\r\n\t\t\tevents.trigger(_vm, 'folder-contents-ui-updated');\r\n\t\t}\r\n\r\n\t\tfunction fireFolderSelected(folder) {\r\n\t\t\tevents.trigger(_vm, 'folder-contents-folder-selected', { folder: folder });\r\n\t\t}\r\n\r\n\t\tfunction fireFolderOpened(folder) {\r\n\t\t\tevents.trigger(_vm, 'folder-contents-folder-opened', { folder: folder });\r\n\t\t}\r\n\r\n\t\tfunction fireFileSelected(file) {\r\n\t\t\tevents.trigger(_vm, 'folder-contents-file-selected', { file: file });\r\n\t\t}\r\n\r\n\t\tfunction fireFileSelectedComplete(file) {\r\n\t\t\tevents.trigger(_vm, 'folder-contents-file-selected-complete', { file: file });\r\n\t\t}\r\n\r\n\t\tfunction getItemWithId(id) {\r\n\r\n\t\t\treturn _(_contents).find(function(item) {\r\n\t\t\t\treturn item.id === id;\r\n\t\t\t});\r\n\t\t}\r\n\r\n\t\tfunction onItemSelected() {\r\n\r\n\t\t\t$(this)\r\n\t\t\t\t.siblings()\r\n\t\t\t\t.removeClass('selected')\r\n\t\t\t\t.end()\r\n\t\t\t\t.addClass('selected');\r\n\t\t}\r\n\r\n\t\tfunction onFileClicked() {\r\n\r\n\t\t\tvar item = getContentItemFromElement(this);\r\n\r\n\t\t\tif (_selected.set(item)) {\r\n\t\t\t\tfireFileSelected(item);\r\n\t\t\t}\r\n\t\t}\r\n\r\n\t\tfunction onFileDoubleClicked() {\r\n\r\n\t\t\tvar item = getContentItemFromElement(this);\r\n\r\n\t\t\tfireFileSelectedComplete(item);\r\n\t\t}\r\n\r\n\t\tfunction onFolderClicked() {\r\n\r\n\t\t\tvar item = getContentItemFromElement(this);\r\n\r\n\t\t\tif (_selected.set(item)) {\r\n\t\t\t\tfireFolderSelected(item);\r\n\t\t\t}\r\n\t\t}\r\n\r\n\t\tfunction onFolderDoubleClicked() {\r\n\r\n\t\t\tvar item = getContentItemFromElement(this);\r\n\r\n\t\t\tfireFolderOpened(item);\r\n\t\t}\r\n\r\n\t\tfunction getContentItemFromElement(element) {\r\n\r\n\t\t\tvar id = element.getAttribute('data-id');\r\n\t\t\treturn getItemWithId(id);\r\n\t\t}\r\n\r\n\t\tfunction Selected() {\r\n\r\n\t\t\tvar _file = null;\r\n\r\n\t\t\tthis.get = function() {\r\n\t\t\t\treturn _file;\r\n\t\t\t}\r\n\r\n\t\t\tthis.set = function(file) {\r\n\r\n\t\t\t\tif (file == _file) {\r\n\t\t\t\t\treturn false;\r\n\t\t\t\t}\r\n\r\n\t\t\t\t_file = file || null;\r\n\t\t\t\treturn true;\r\n\t\t\t};\r\n\t\t}\r\n\t}\r\n\r\n\r\n\tfunction FolderTree(vm, ctx) {\r\n\r\n\t\tvar _this = this,\r\n\t\t\t_ctx = ctx,\r\n\t\t\t_vm = vm,\r\n\t\t\t_folders = null,\r\n\t\t\t_selected = new Selected();\r\n\r\n\t\t// Due to the fact it fires only through jquery, and not natively we use this method with jstree\r\n\t\t_vm.on('select_node.jstree', function(e, data) {\r\n\r\n\t\t\tvar id = data.node.a_attr['data-id'];\r\n\t\t\tvar folder = getFolderWithId(id);\r\n\r\n\t\t\t_selected.set(folder);\r\n\r\n\t\t\tfireDirectoryChanged(folder);\r\n\r\n\t\t\te.stopPropagation();\r\n\t\t});\r\n\r\n\t\t_ctx.getFolderTree().done(onFolderTreeLoaded);\r\n\r\n\t\tthis.selectById = function(id) {\r\n\t\t\t// Selects node, which fires is caught and then is rethrown with relevant data for subscribers\r\n\t\t\t_vm.jstree('deselect_all');\r\n\t\t\t_vm.jstree('select_node', _vm.find('[data-id=\"' + id + '\"]').parent());\r\n\t\t};\r\n\r\n\t\tthis.getSelectedFolderPath = function() {\r\n\r\n\t\t\treturn _selected.getPath();\r\n\t\t}\r\n\r\n\t\tfunction getFolderWithId(id) {\r\n\t\t\treturn findFolderRecursive(_folders, id);\r\n\t\t}\r\n\r\n\t\t/**\r\n\t\t * Searches through the loaded folders\r\n\t\t */\r\n\t\tfunction findFolderRecursive(dir, id) {\r\n\r\n\t\t\tif (dir.id === id) {\r\n\t\t\t\treturn dir;\r\n\t\t\t}\r\n\r\n\t\t\tfor (var i = 0, n = dir.directories.length; i < n; i++) {\r\n\t\t\t\tvar result = findFolderRecursive(dir.directories[i], id);\r\n\t\t\t\tif (result) {\r\n\t\t\t\t\treturn result;\r\n\t\t\t\t}\r\n\t\t\t}\r\n\r\n\t\t\treturn null;\r\n\t\t}\r\n\r\n\t\tfunction fireDirectoryChanged(folder) {\r\n\t\t\tevents.trigger(_vm, 'folder-tree-folder-changed', { folder: folder });\r\n\t\t}\r\n\r\n\t\tfunction onFolderTreeLoaded(data) {\r\n\r\n\t\t\t_folders = data || null;\r\n\t\t\tcreateTree(data);\r\n\t\t}\r\n\r\n\t\tfunction createTree(data) {\r\n\r\n\t\t\tvar tree = _vm.jstree({\r\n\t\t\t\tcore: {\r\n\t\t\t\t\tdata: toTreeNode(data)\r\n\t\t\t\t}\r\n\t\t\t});\r\n\r\n\t\t\ttree.on(\"ready.jstree\", function() {\r\n\t\t\t\t_this.selectById(\"Lw\");\r\n\t\t\t});\r\n\t\t}\r\n\r\n\t\t/**\r\n\t\t* Takes the DirectoryItem data and converts it into a format used by jsTree, creates the tree re-cursively\r\n\t\t*/\r\n\t\tfunction toTreeNode(data) {\r\n\r\n\t\t\treturn {\r\n\t\t\t\tid: 'folder-item-' + data.id,\r\n\t\t\t\ttext: data.name,\r\n\t\t\t\ta_attr: {\r\n\t\t\t\t\t'data-path': data.path,\r\n\t\t\t\t\t'data-id': data.id,\r\n\t\t\t\t\t'class': 'tree-item-folder'\r\n\t\t\t\t},\r\n\t\t\t\tstate: {\r\n\t\t\t\t\topened: true\r\n\t\t\t\t},\r\n\t\t\t\tchildren: _(data.directories).map(toTreeNode)\r\n\t\t\t}\r\n\t\t}\r\n\r\n\t\tfunction Selected() {\r\n\r\n\t\t\tvar _folder = null;\r\n\r\n\t\t\tthis.get = function() {\r\n\t\t\t\treturn _folder;\r\n\t\t\t}\r\n\r\n\t\t\tthis.getPath = function() {\r\n\t\t\t\treturn (_folder) ? _folder.path : null;\r\n\t\t\t};\r\n\r\n\t\t\tthis.set = function(folder) {\r\n\r\n\t\t\t\tif (folder == _folder) {\r\n\t\t\t\t\treturn false;\r\n\t\t\t\t}\r\n\r\n\t\t\t\t_folder = folder || null;\r\n\t\t\t\treturn true;\r\n\t\t\t};\r\n\r\n\t\t\tthis.clear = function() {\r\n\t\t\t\t_folder = null;\r\n\t\t\t};\r\n\r\n\t\t\tthis.has = function() {\r\n\t\t\t\treturn _folder === null;\r\n\t\t\t};\r\n\t\t}\r\n\t}\r\n\r\n\tfunction DetailsBar(vm, ctx) {\r\n\r\n\t\tvar _vm = vm,\r\n\t\t\t_ctx = ctx,\r\n\t\t\t_this = this,\r\n\t\t\t_selected = null,\r\n\t\t\t_fileSelected = $('.file-selected', vm);\r\n\r\n\t\tevents.on(_vm, 'click', '.delete', onDeleteClick);\r\n\r\n\t\tthis.updateSelected = function(file) {\r\n\r\n\t\t\tif (file) {\r\n\t\t\t\t_selected = file;\r\n\t\t\t\t_fileSelected.text(file.name);\r\n\t\t\t\t_fileSelected.attr({ href: file.link });\r\n\t\t\t}\r\n\t\t\telse {\r\n\t\t\t\t_selected = null;\r\n\t\t\t\t_fileSelected.text('');\r\n\t\t\t}\r\n\t\t}\r\n\r\n\t\tfunction onDeleteClick() {\r\n\r\n\t\t\tif (!_selected) {\r\n\t\t\t\treturn;\r\n\t\t\t}\r\n\r\n\t\t\tmessage.confirm('Are you sure you want to delete this file? \\n\\nIt could be being used', function(answer) {\r\n\r\n\t\t\t\tif (!answer) {\r\n\t\t\t\t\treturn;\r\n\t\t\t\t}\r\n\r\n\t\t\t\t_ctx.deleteItem(_selected.id).done(fireOnDelete);\r\n\t\t\t});\r\n\t\t}\r\n\r\n\t\tfunction fireOnDelete() {\r\n\t\t\t_this.updateSelected(null);\r\n\t\t\tevents.trigger(_vm, 'details-bar-item-deleted');\r\n\t\t}\r\n\t}\r\n\r\n\tfunction DataContext(apiUrl, token) {\r\n\r\n\t\tvar _root = apiUrl,\r\n\t\t\t_token = (typeof token === \"string\") ? function() { return token; } : typeof token === \"function\" ? token : null;\r\n\t\t\t\r\n\t\tif(_token) {\r\n\t\t\t$.ajaxSetup({\r\n\t\t\t\tbeforeSend: function(xhr) {\r\n\t\t\t\t\txhr.setRequestHeader(\"Authorization\", \"Bearer \" + token());\r\n\t\t\t\t}\r\n\t\t\t});\r\n\t\t}\r\n\r\n\t\tfunction resolveApi(path) {\r\n\t\t\treturn _root + path;\r\n\t\t}\r\n\r\n\t\tthis.deleteItem = function(id) {\r\n\r\n\t\t\treturn $.ajax({\r\n\t\t\t\turl: resolveApi('/api/browser/file/' + id),\r\n\t\t\t\ttype: 'DELETE',\r\n\t\t\t\tdataType: 'json'\r\n\t\t\t});\r\n\t\t};\r\n\r\n\t\tthis.getFolderContent = function(folderPath) {\r\n\r\n\t\t\treturn $.getJSON(resolveApi('/api/browser/folder/contents'), { path: folderPath });\r\n\t\t};\r\n\r\n\t\tthis.getFolderTree = function() {\r\n\t\t\treturn $.getJSON(resolveApi('/api/browser/folder'));\r\n\t\t}\r\n\r\n\t\tthis.resolveApi = resolveApi;\r\n\t}\r\n\r\n})(jQuery, _, window.lski.events, window.lski.alerts, window, document);"],"sourceRoot":"/source/"}